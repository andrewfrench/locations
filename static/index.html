<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Where I Went</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	<script src="https://polyfill.io/v3/polyfill.min.js?features=Array.from,Promise,Symbol,Object.setPrototypeOf,Object.getOwnPropertySymbols"></script>
	<script src="https://cdn.jsdelivr.net/npm/superagent"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
		#info {
			width: 1px;
			height: 1px;
			padding: 0px 10px;
			background-color: rbga(255, 255, 255, 0.5);
			position: fixed;
			left: 0;
			top: 0;
		}
    </style>
</head>
<body>
<div id='map'></div>
<div id='info'>
	<pre><b>Generated</b> <div id="generated"></div></pre>
	<pre><b>First data point</b> <div id="first"></div></pre>
	<pre><b>Last data point</b> <div id="last"></div></pre>
	<pre><b>Size</b> <div id="num"></div></pre>
	<pre><div id="version"></div></pre>
</div>
<script>
var version = "v2019.12.15.230722" // inserted by make
mapboxgl.accessToken = "pk.eyJ1IjoiYW5kcmV3ZnJlbmNoIiwiYSI6ImNrNDZhZ29hYzBmNjUzbG1ubmYzdWNscXgifQ.PsRxHiw1rREV2m0wWpz4UQ"
var digestUrl = "https://map.afren.ch/data/digest.json"
var mapOptions = {
	container: 'map',
	style: 'mapbox://styles/andrewfrench/cjwh6n2474cdd1cqeklcaaiuj',
	center: [-127, 46],
	zoom: 2,
	minZoom: 2,
	maxZoom: 11,
};
var layerOptions = {
	"id": "location-features",
	"type": "heatmap",
	"source": "locations",
	"paint": {
		"heatmap-color": [
			"step",
			["heatmap-density"],
			"rgba(0, 0, 255, 0)",
			0.1, "royalblue",
			0.3, "cyan",
			0.5, "lime",
			0.7, "yellow",
			1, "red"
		],
		"heatmap-opacity": 0.75,
		"heatmap-radius": [
			"interpolate",
			["exponential", 1.5],
			["zoom"],
			0, 8,
			12, 10
		],
		"heatmap-weight": {
			type: "exponential",
			stops: [
				[1, 0.3],
				[100, 0.3],
				[1000, 1]
			]
		}
	}
}
var geoJson = {};
superagent.get(digestUrl)
	.then(res => {
		now = new Date().getTime();
		document.getElementById("version").innerHTML = version
		document.getElementById("num").innerHTML = res.body["size"];
		firstAgo = (((now/1000) - res.body["firstTimestamp"]) / (60*60*24)).toFixed(0);
		lastAgo = (((now/1000) - res.body["lastTimestamp"]) / (60*60)).toFixed(0);
		generatedAgo = (((now/1000) - res.body["generatedAt"]) / (60*60)).toFixed(0);
		document.getElementById("first").innerHTML = ( firstAgo > 1 ? firstAgo + " days" : "1 day" ) + " ago";
		document.getElementById("last").innerHTML = ( lastAgo > 1 ? lastAgo + " hours": "1 hour" ) + " ago";
		document.getElementById("generated").innerHTML = ( generatedAgo > 1 ? generatedAgo + " hours" : "1 hour" )+ " ago";
		geoJsonPoints = new Array();
		for (i = 0; i < res.body["points"].length; i++) {
			geoJsonPoints.push({
				"type": "Feature",
				"geometry": {
					"type": "Point",
					"coordinates": [res.body["points"][i]["lng"], res.body["points"][i]["lat"]]
				}
			})
		};
		geoJson = {
			"type": "FeatureCollection",
			"features": geoJsonPoints
		};
		var map = new mapboxgl.Map(mapOptions);
		map.on('load', function() {
			map.addSource('locations', {
				"type": "geojson",
				"data": geoJson
			});
			map.addLayer(layerOptions);
		});
	})
	.catch(err => {
		alert(err.message)
	})
</script>
</body>
</html>
