<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Where I Went</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map {
		position: absolute;
		top: 0;
		bottom: 0;
		width: 100%;
		background-color: #242525;
	}
	#info {
		color: #ccc;
		width: 1px;
		height: 1px;
		padding: 0px 10px;
		position: fixed;
		left: 0;
		top: 0;
	}
    </style>
</head>
<body>
<div id='map'></div>
<script>
// Geohash decoding modified from geohash.js
// (c) 2008 David Troy
// Distributed under the MIT License

BITS = [16, 8, 4, 2, 1];
BASE32 = "0123456789bcdefghjkmnpqrstuvwxyz";

function refine_interval(interval, cd, mask) {
	if (cd&mask)
		interval[0] = (interval[0] + interval[1])/2;
  else
		interval[1] = (interval[0] + interval[1])/2;
}

function decodeGeoHash(geohash) {
	var is_even = 1;
	var lat = []; var lon = [];
	lat[0] = -90.0;  lat[1] = 90.0;
	lon[0] = -180.0; lon[1] = 180.0;
	lat_err = 90.0;  lon_err = 180.0;
	
	for (i=0; i<geohash.length; i++) {
		c = geohash[i];
		cd = BASE32.indexOf(c);
		for (j=0; j<5; j++) {
			mask = BITS[j];
			if (is_even) {
				lon_err /= 2;
				refine_interval(lon, cd, mask);
			} else {
				lat_err /= 2;
				refine_interval(lat, cd, mask);
			}
			is_even = !is_even;
		}
	}
	return [(lon[0] + lon[1])/2, (lat[0] + lat[1])/2];
}

function inflate(deflated) {
    var coords = [];
    var window = deflated[0]
    for (i in deflated) {
        let skip = window.length - deflated[i].length;
        window = window.substring(0, skip) + deflated[i];
		let decoded = decodeGeoHash(window);
        coords.push(decoded);
    }

	return coords;
}

mapboxgl.accessToken = "pk.eyJ1IjoiYW5kcmV3ZnJlbmNoIiwiYSI6ImNrNDZhazB1ODBpZDAzZ28xdHd5bHNrb28ifQ.QhjFyb7aaV6n6kYIG3Vukw";
var digestUrl = "https://map.afren.ch/andrew/data/2022.json";

var mapOptions = {
	container: "map",
	style: "mapbox://styles/andrewfrench/ck8z9c96s067j1ioc37hrkjl4",
	center: [-127, 46],
	zoom: 2,
	minZoom: 2,
	maxZoom: 11,
};

var pointLayer = {
	"id": "pointLayer",
	"type": "circle",
	"source": "locations",
	"paint": {
		"circle-color": "#ffc038",
		"circle-radius": 2,
		"circle-opacity": 0.5
	}
};

var geoJson = {};
fetch(digestUrl)
	.then((response) => response.json())
	.then((data) => {
		console.log(data);
		geoJsonPoints = new Array();
		inflated = inflate(data["points"])
		for (i = 0; i < inflated.length; i++) {
			geoJsonPoints.push({
				"type": "Feature",
				"geometry": {
					"type": "Point",
					"coordinates": inflated[i]
				}
			})
		};
		geoJson = {
			"type": "FeatureCollection",
			"features": geoJsonPoints
		};
		var map = new mapboxgl.Map(mapOptions);
		map.on('load', function() {
			map.addSource('locations', {
				"type": "geojson",
				"data": geoJson
			});
			map.addLayer(pointLayer);
		});
	})
	.catch(err => {
		console.error(err.message)
	})
</script>
</body>
</html>
